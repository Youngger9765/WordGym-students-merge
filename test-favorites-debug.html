<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Favorites Debug Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .primary {
      background: #4f46e5;
      color: white;
    }
    .secondary {
      background: #e5e7eb;
      color: #374151;
    }
    .danger {
      background: #ef4444;
      color: white;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
    }
    .info {
      background: #dbeafe;
      color: #1e40af;
    }
  </style>
</head>
<body>
  <h1>Favorites System Debug Test</h1>

  <div class="test-section">
    <h2>1. Check Current State</h2>
    <button class="primary" onclick="checkState()">Check localStorage State</button>
    <button class="secondary" onclick="clearFavorites()">Clear All Favorites</button>
    <div id="state-output"></div>
  </div>

  <div class="test-section">
    <h2>2. Simulate Adding Favorites</h2>
    <button class="primary" onclick="addFavorite(1)">Add Word ID 1</button>
    <button class="primary" onclick="addFavorite(5)">Add Word ID 5</button>
    <button class="primary" onclick="addFavorite(10)">Add Word ID 10</button>
    <div id="add-output"></div>
  </div>

  <div class="test-section">
    <h2>3. Test Set Operations</h2>
    <button class="primary" onclick="testSetBehavior()">Test Set Behavior</button>
    <div id="set-output"></div>
  </div>

  <div class="test-section">
    <h2>4. Test useFavorites Hook Logic</h2>
    <button class="primary" onclick="testHookLogic()">Simulate Hook Logic</button>
    <div id="hook-output"></div>
  </div>

  <div class="test-section">
    <h2>5. Instructions for Manual Test</h2>
    <div class="status info">
      <strong>Manual Testing Steps:</strong><br>
      1. Open <code>dist/index.html</code> in browser<br>
      2. Open DevTools Console (F12)<br>
      3. Click on any word card to go to detail page<br>
      4. Click "加入重點訓練" button<br>
      5. In Console, run: <code>localStorage.getItem('mvp_vocab_favorites')</code><br>
      6. Navigate to <code>#/favorites</code><br>
      7. Check if word appears in favorites page
    </div>
  </div>

  <script>
    const LS_KEY = 'mvp_vocab_favorites';

    function log(elementId, message, type = 'info') {
      const output = document.getElementById(elementId);
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      output.innerHTML = '';
      output.appendChild(div);
    }

    function checkState() {
      const raw = localStorage.getItem(LS_KEY);
      let message = '<strong>localStorage State:</strong><br>';

      if (!raw) {
        message += '❌ No favorites found in localStorage<br>';
        message += '<pre>null</pre>';
        log('state-output', message, 'error');
        return;
      }

      message += '✅ Data found:<br>';
      message += `<pre>${raw}</pre>`;

      try {
        const parsed = JSON.parse(raw);
        message += '<strong>Parsed Value:</strong><br>';
        message += `<pre>${JSON.stringify(parsed, null, 2)}</pre>`;
        message += `<strong>Type:</strong> ${Array.isArray(parsed) ? 'Array' : typeof parsed}<br>`;
        message += `<strong>Length:</strong> ${Array.isArray(parsed) ? parsed.length : 'N/A'}<br>`;

        if (Array.isArray(parsed)) {
          const set = new Set(parsed.map(Number));
          message += `<strong>As Set:</strong> ${set.size} items<br>`;
          message += `<pre>${JSON.stringify([...set], null, 2)}</pre>`;
        }

        log('state-output', message, 'success');
      } catch (e) {
        message += '<strong>Parse Error:</strong><br>';
        message += `<pre>${e.message}</pre>`;
        log('state-output', message, 'error');
      }
    }

    function clearFavorites() {
      localStorage.removeItem(LS_KEY);
      log('state-output', '✅ Favorites cleared', 'success');
    }

    function addFavorite(wordId) {
      try {
        const raw = localStorage.getItem(LS_KEY);
        let favorites = new Set();

        if (raw) {
          const parsed = JSON.parse(raw);
          favorites = new Set(Array.isArray(parsed) ? parsed.map(Number) : []);
        }

        favorites.add(wordId);
        localStorage.setItem(LS_KEY, JSON.stringify([...favorites]));

        log('add-output', `✅ Added word ID ${wordId}<br>Current favorites: ${[...favorites].join(', ')}`, 'success');
        checkState();
      } catch (e) {
        log('add-output', `❌ Error: ${e.message}`, 'error');
      }
    }

    function testSetBehavior() {
      let message = '<strong>Testing Set Operations:</strong><br>';

      // Test 1: Create Set from array
      const arr = [1, 2, 3, 2, 1];
      const set1 = new Set(arr);
      message += `Test 1: new Set([1,2,3,2,1]) → ${[...set1].join(', ')}<br>`;

      // Test 2: Add to Set
      set1.add(4);
      message += `Test 2: After add(4) → ${[...set1].join(', ')}<br>`;

      // Test 3: Has check
      message += `Test 3: set1.has(2) → ${set1.has(2)}<br>`;
      message += `Test 3: set1.has(5) → ${set1.has(5)}<br>`;

      // Test 4: String to number
      const strArr = ['1', '2', '3'];
      const set2 = new Set(strArr.map(Number));
      message += `Test 4: new Set(['1','2','3'].map(Number)) → ${[...set2].join(', ')}<br>`;

      // Test 5: Serialize and deserialize
      const serialized = JSON.stringify([...set1]);
      const deserialized = JSON.parse(serialized);
      const set3 = new Set(deserialized.map(Number));
      message += `Test 5: Serialize → Deserialize → Set<br>`;
      message += `  Serialized: ${serialized}<br>`;
      message += `  Final Set: ${[...set3].join(', ')}<br>`;

      log('set-output', message, 'success');
    }

    function testHookLogic() {
      let message = '<strong>Simulating useFavorites Hook Logic:</strong><br>';

      // Clear first
      localStorage.removeItem(LS_KEY);
      message += 'Step 1: Clear localStorage<br>';

      // Initialize (like useState)
      let favorites = new Set();
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          favorites = new Set(Array.isArray(parsed) ? parsed.map(Number) : []);
        }
      } catch {}
      message += `Step 2: Initialize favorites → ${favorites.size} items<br>`;

      // Add favorite (like addFavorite function)
      const addFavorite = (wordId) => {
        const next = new Set(favorites);
        next.add(wordId);
        favorites = next;

        // Save to localStorage (like useEffect)
        try {
          localStorage.setItem(LS_KEY, JSON.stringify([...favorites]));
          message += `Step 3: Added word ${wordId} → localStorage updated<br>`;
        } catch (e) {
          message += `❌ Error saving: ${e.message}<br>`;
        }
      };

      // Test adding
      addFavorite(42);
      message += `Step 4: favorites.has(42) → ${favorites.has(42)}<br>`;

      // Check localStorage
      const savedRaw = localStorage.getItem(LS_KEY);
      message += `Step 5: localStorage value → ${savedRaw}<br>`;

      // Test reload (like page refresh)
      let reloadedFavorites = new Set();
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          reloadedFavorites = new Set(Array.isArray(parsed) ? parsed.map(Number) : []);
        }
      } catch {}
      message += `Step 6: After reload simulation → ${reloadedFavorites.size} items<br>`;
      message += `Step 7: reloadedFavorites.has(42) → ${reloadedFavorites.has(42)}<br>`;

      if (favorites.has(42) && reloadedFavorites.has(42)) {
        message += '<br>✅ Hook logic works correctly!';
        log('hook-output', message, 'success');
      } else {
        message += '<br>❌ Hook logic has issues!';
        log('hook-output', message, 'error');
      }
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      checkState();
    });
  </script>
</body>
</html>
