# 生产环境测试强制规范

**生效日期**: 2025-12-31
**目的**: 杜绝"代码能跑就行"心态，强制验证真实用户体验
**规范等级**: CRITICAL - 所有Issues必须遵循

---

## 核心原则

> **代码能编译 ≠ 修复成功**
>
> 修复的定义：在生产环境中，用户看到的问题已解决，且无副作用。

---

## 验证流程阶段

### Phase 1: 修复前证据收集 (Plan阶段)

**目标**: 记录修复前的现象，作为验证的基线

**检查清单**:
- [ ] 明确问题现象描述
- [ ] 按照Issue中的复现步骤实施一遍
- [ ] 在生产环境URL上截屏：`https://youngger9765.github.io/WordGym-students-merge/`
- [ ] 记录浏览器版本、屏幕尺寸
- [ ] 检查Console是否有错误
- [ ] 如涉及数据：验证当前数据状态

**输出物**:
```markdown
### 问题现象（修复前）

环境：
- URL: https://youngger9765.github.io/WordGym-students-merge/
- 浏览器: Chrome 131.0.6778.204
- 屏幕尺寸: 1920x1080

复现步骤：
1. [步骤1]
2. [步骤2]
3. [步骤3]

问题表现：
[详细描述或截屏]

Console状态：
- 无错误
- 有警告: [列表]
```

---

### Phase 2: 修复实施 (Do阶段)

**目标**: 实施代码修改

**强制规范**:
- ✅ 必须有提交信息
- ✅ 必须遵循conventional commits
- ✅ 必须包含修复的文件列表
- ✅ 不能直接push到main
- ✅ 必须通过本地测试

**不允许**:
- ❌ 拆分成多个无相关的提交
- ❌ 提交未完成的代码
- ❌ 提交中间的调试代码

---

### Phase 3: 本地验证 (Do末尾)

**目标**: 在本地开发环境验证修复

**检查清单**:
- [ ] `npm run build` 成功
- [ ] 无TypeScript错误
- [ ] `npm run preview` 启动成功
- [ ] 在http://localhost:4173/ 上测试修复
- [ ] Console无错误

**如果此阶段失败**:
- ❌ 不能进入下一阶段
- ✅ 返回Do阶段修复问题

---

### Phase 4: 生产环境部署 (Check阶段前)

**目标**: 确保修复代码到达生产环境

**流程**:
1. 合并PR到main分支
2. 触发GitHub Actions部署
3. 等待部署完成（检查Actions日志）
4. 验证生产环境已更新

**验证步骤**:
- [ ] 访问生产URL
- [ ] 清除浏览器缓存（Ctrl+Shift+Delete）
- [ ] 刷新页面（Ctrl+Shift+R强制刷新）
- [ ] 检查Network标签：JS/CSS文件大小是否改变

**如果此阶段失败**:
- ❌ 不能进入Check阶段
- ✅ 调查部署问题
- ✅ 等待部署完成

---

### Phase 5: 生产环境Chrome验证 (Check阶段核心)

**这是强制的关卡。无法通过此阶段 = 无法关闭Issue。**

#### 验证步骤

**Step 1: 准备验证环境**
```
浏览器: Chrome (最新版本)
URL: https://youngger9765.github.io/WordGym-students-merge/
缓存: 已清除
设备: [记录设备信息]
```

**Step 2: 按照原始复现步骤测试**
```
复现步骤（同修复前）:
1. [步骤1]
2. [步骤2]
3. [步骤3]

验证结果:
- 问题现象是否消失? ✅ / ❌
- 是否有新的问题? ✅ / ❌
- Console是否有错误? ✅ / ❌
```

**Step 3: 对比修复前后**
```
修复前: [截屏]
修复后: [截屏]
对比: [描述差异]
```

**Step 4: 检查副作用**
```
受影响的功能:
- [ ] 功能A: ✅ 正常 / ⚠️ 受影响 / ❌ 损坏
- [ ] 功能B: ✅ 正常 / ⚠️ 受影响 / ❌ 损坏
- [ ] 功能C: ✅ 正常 / ⚠️ 受影响 / ❌ 损坏
```

**Step 5: 性能验证**
```
Chrome DevTools:
- [ ] 检查Network: 加载时间是否合理
- [ ] 检查Console: 无错误、无warning
- [ ] 检查Performance: 无长耗时任务
```

#### 验证报告模板

```markdown
## Chrome 生产环境验证报告

### 验证环境
- 时间: [时间戳]
- 浏览器: Chrome [版本号]
- URL: https://youngger9765.github.io/WordGym-students-merge/
- 设备: [设备描述]

### 修复前（BEFORE）
[截屏]

### 修复后（AFTER）
[截屏]

### 对比分析
- 问题现象: ✅ 已解决 / ❌ 仍然存在
- 新增问题: ✅ 无 / ⚠️ [描述]
- Console错误: ✅ 无 / ⚠️ [列表]

### 副作用检查
- 功能A: ✅ 正常
- 功能B: ✅ 正常
- 功能C: ✅ 正常

### 性能检查
- Network: ✅ 加载时间 [Xms]
- Console: ✅ 无错误
- Performance: ✅ 无长耗时

### 结论
✅ **验证通过** - 问题已解决，无副作用
或
❌ **验证失败** - [原因] → 返回Do阶段修复

### 验证者
签名: [AI Agent] @ [时间]
```

---

## Issue类型特定的验证规范

### 1. UI/样式问题 (如Issue #26)

**必须验证**:
- [ ] 多个屏幕尺寸 (375px, 768px, 1024px, 1920px)
- [ ] 不同浏览器 (Chrome, Safari, Firefox - 如适用)
- [ ] 深色/浅色主题 (如适用)
- [ ] 移动设备竖屏/横屏

**验证报告包含**:
- 各尺寸截屏
- 视觉一致性对比
- 响应式设计验证

### 2. 数据过滤问题 (如Issue #31)

**必须验证**:
- [ ] 数据分离是否符合预期
- [ ] 词汇数量是否合理
- [ ] 是否有数据遗漏
- [ ] 所有过滤选项的组合

**验证报告包含**:
- 各级别词汇数量统计
- 过滤逻辑验证
- 边界情况测试

**关键问题**:
```
修复前词数: [数字]
修复后词数: [数字]
差异分析:
- 减少的词是否应该被排除?
- 是否遗漏了相关词汇?
```

### 3. 功能/级联问题 (如Issue #25)

**必须验证**:
- [ ] 完整用户流程
- [ ] 所有参数组合
- [ ] 状态的一致性
- [ ] 页面重载后的持久性

**验证报告包含**:
- 逐步操作流程记录
- 状态变化截屏
- 最终结果验证

### 4. 功能显示问题 (如Issue #27)

**必须验证**:
- [ ] 所有相关内容都显示
- [ ] 布局和排版是否正确
- [ ] 文本是否溢出
- [ ] 内容完整性

**验证报告包含**:
- 内容显示截屏
- 完整性检查清单
- 布局验证

---

## 特殊情况处理

### 场景1: 问题涉及多个条件

**例**: 修复只在特定版本/阶段适用

**验证要求**:
- 测试该条件下的修复
- 测试其他条件是否受影响
- 确保条件逻辑清晰

### 场景2: 修复影响大量功能

**例**: 改变了核心过滤逻辑

**验证要求**:
- 测试所有依赖该功能的流程
- 性能监测 (是否有新的瓶颈)
- 数据一致性检查

### 场景3: 修复存在已知限制

**例**: 仅修复了主流浏览器

**处理方式**:
- 在Issue中清晰记录限制
- 标记为 `known-limitation` 标签
- 计划在后续Issues中修复

---

## Check阶段的检查清单

在Check阶段合并PR前，以下所有项目都必须✅通过：

```markdown
## Check阶段验证清单

### 代码层面
- [ ] npm run build 成功
- [ ] TypeScript无错误
- [ ] 提交信息符合conventional commits
- [ ] 代码审查通过

### 本地测试
- [ ] npm run preview 可启动
- [ ] http://localhost:4173/ 功能正常
- [ ] Console无错误

### 生产部署
- [ ] GitHub Actions部署成功
- [ ] 生产URL可访问

### 生产环境验证
- [ ] 清除浏览器缓存后仍有效
- [ ] 生产环境Chrome验证通过
- [ ] 问题现象已解决
- [ ] 无新增问题
- [ ] 副作用检查通过
- [ ] 性能正常

### 报告
- [ ] 验证报告已发布
- [ ] BEFORE/AFTER截屏已上传
- [ ] 验证者签名

任何一项❌ = Check失败 → 返回Do阶段修复
```

---

## 处罚机制

### 违规行为

**违规1**: 声称"已修复"但无Chrome验证截屏
```
处理:
- PR要求修改
- 必须补充Chrome验证报告
- 才能合并
```

**违规2**: Check阶段跳过生产环境验证
```
处理:
- Issue不能关闭
- 客户有权再次报告问题
- 修复需要重新进行
```

**违规3**: 提供虚假的验证报告
```
处理:
- 严重影响工作流程
- 信任度降低
- 未来所有修复需要更严格审查
```

---

## 与git-issue-pr-flow的整合

### PDCA流程中的验证位置

```
Plan: 5 Whys分析 + 需求澄清
  ↓
Do: 实施修复 + 本地验证
  ↓
Check: ✨ 生产环境Chrome验证 ✨ (新增强制关卡)
  ├─ 验证报告
  ├─ 截屏证据
  └─ 副作用检查
  ↓
Act: 等待客户反馈 / 关闭Issue
```

### Check失败时的流程

```
Check失败 → 分析失败原因
  ├─ 如果是数据问题: 返回Do阶段修复数据
  ├─ 如果是副作用: 返回Do阶段改进修复
  └─ 如果无法修复: 发起客户澄清
```

---

## 示例：Issue #31应该如何进行

### 修复前验证 (Plan)

```
访问生产URL，选择"国中"：
[截屏显示国中+高中混合的词汇]

数据统计:
- 显示词汇数: [数字]
- 其中国中词: [数字]
- 其中高中词: [数字]
- 混合: 是 ✗
```

### 修复后验证 (Check)

```
访问生产URL，选择"国中"：
[截屏显示纯国中词汇]

数据统计:
- 显示词汇数: [数字]
- 其中国中词: [数字]
- 其中高中词: 0 ✓
- 混合: 否 ✓

但要检查:
- 修复前显示的词汇总数: X个
- 修复后显示的词汇总数: Y个
- 失去的词汇: X - Y = Z个

Q: Z个词汇是否应该被排除?
  如果不应该: 修复不完整
  如果应该: 修复成功 ✓
```

---

## 常见问题

**Q: 这样会不会太耗时？**
A: 不会。生产环境验证通常只需5-10分钟，远少于客户后来反馈"仍然有问题"的开销（需要重新修复、重新部署、重新测试）。

**Q: 如果问题很明显，还需要全部验证吗？**
A: 是的。明显的问题有时带来隐蔽的副作用。例如Issue #31：代码看起来很对，但实际效果（3237个词消失）是出乎意料的。

**Q: 如果修复是完全在后端，不涉及UI？**
A: 仍然需要验证。检查清单会调整为：
- 数据验证
- API响应
- 性能监测
- Console检查

**Q: 生产环境验证失败怎么办？**
A: 不能合并PR。必须：
1. 分析失败原因
2. 返回Do阶段修复
3. 重新进行验证
4. 直到Check通过

---

## 总结

**生产环境测试强制规范的目的**:
- ✅ 确保修复真的有效
- ✅ 发现副作用
- ✅ 避免客户报告"仍然有问题"
- ✅ 建立信任和质量标准

**核心要求**:
- 没有Chrome验证报告 = 无法关闭Issue
- 代码能编译 ≠ 修复成功
- 生产环境体验 = 真实验证

---

*规范生效日期: 2025-12-31 | 所有Issues必须遵循此规范*
