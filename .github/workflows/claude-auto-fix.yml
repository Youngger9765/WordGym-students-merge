name: Claude Auto-Fix

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-fix:
    # åªåœ¨ CI å¤±æ•—æ™‚è§¸ç™¼
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check retry count
        id: retry-check
        run: |
          # æª¢æŸ¥æœ€è¿‘çš„ commits ä¸­æœ‰å¤šå°‘æ˜¯ Claude auto-fix
          RETRY_COUNT=$(git log --oneline -10 --grep="ğŸ¤– Claude Auto-Fix" | wc -l | tr -d ' ')
          echo "retry_count=$RETRY_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š ç•¶å‰é‡è©¦æ¬¡æ•¸: $RETRY_COUNT"

          if [ $RETRY_COUNT -ge 3 ]; then
            echo "should_stop=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ å·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ (3)"
          else
            echo "should_stop=false" >> $GITHUB_OUTPUT
            echo "âœ… å¯ä»¥ç¹¼çºŒè‡ªå‹•ä¿®å¾©"
          fi

      - name: Stop and comment if max retries reached
        if: steps.retry-check.outputs.should_stop == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.workflow_run.pull_requests[0]?.number;

            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: `## ğŸš¨ Claude Auto-Fix å¤±æ•—å ±å‘Š

            å˜—è©¦æ¬¡æ•¸å·²é”ä¸Šé™ (3 æ¬¡)ï¼Œä½†ä»ç„¡æ³•ä¿®å¾© CI éŒ¯èª¤ã€‚

            **éœ€è¦äººå·¥ä»‹å…¥** ğŸ™‹â€â™‚ï¸

            ### å¤±æ•—çš„ Workflow
            - Run: ${{ github.event.workflow_run.html_url }}
            - Branch: \`${{ github.event.workflow_run.head_branch }}\`
            - Commit: ${{ github.event.workflow_run.head_sha }}

            ### å»ºè­°è¡Œå‹•
            1. æª¢æŸ¥æœ€è¿‘ 3 æ¬¡ auto-fix commits
            2. æŸ¥çœ‹ CI éŒ¯èª¤æ—¥èªŒ
            3. æ‰‹å‹•ä¿®å¾©å•é¡Œ

            ### æœ€è¿‘çš„ auto-fix commits
            \`\`\`
            $(git log --oneline -3 --grep="ğŸ¤– Claude Auto-Fix")
            \`\`\`

            @Youngger9765 è«‹å”åŠ©è™•ç† ğŸ™`
              });
            }

            // ä¹Ÿç™¼åˆ° commit ä¸Š
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: '${{ github.event.workflow_run.head_sha }}',
              body: `ğŸš¨ Claude Auto-Fix å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ (3)ï¼Œéœ€è¦äººå·¥ä»‹å…¥ã€‚è©³è¦‹ PR ç•™è¨€ã€‚`
            });

            core.setFailed('å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œåœæ­¢è‡ªå‹•ä¿®å¾©');

      - name: Install dependencies
        if: steps.retry-check.outputs.should_stop == 'false'
        run: npm ci --legacy-peer-deps

      - name: Run auto-fix (ESLint)
        if: steps.retry-check.outputs.should_stop == 'false'
        id: eslint-fix
        run: |
          echo "ğŸ”§ åŸ·è¡Œ ESLint auto-fix..."
          npm run lint -- --fix || true

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --quiet; then
            echo "fixed=false" >> $GITHUB_OUTPUT
            echo "No changes from ESLint fix"
          else
            echo "fixed=true" >> $GITHUB_OUTPUT
            echo "âœ… ESLint ä¿®å¾©äº†ä¸€äº›å•é¡Œ"
          fi

      - name: Run auto-format (Prettier)
        if: steps.retry-check.outputs.should_stop == 'false'
        id: prettier-fix
        run: |
          echo "ğŸ¨ åŸ·è¡Œ Prettier auto-format..."
          npx prettier --write "src/**/*.{ts,tsx,js,jsx,json,css,md}" || true

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --quiet; then
            echo "fixed=false" >> $GITHUB_OUTPUT
            echo "No changes from Prettier"
          else
            echo "fixed=true" >> $GITHUB_OUTPUT
            echo "âœ… Prettier æ ¼å¼åŒ–äº†ä¸€äº›æª”æ¡ˆ"
          fi

      - name: Check if any fixes were made
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ²’æœ‰å¯è‡ªå‹•ä¿®å¾©çš„å•é¡Œ"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å·²ä¿®å¾©ä¸€äº›å•é¡Œ"
            echo "Changed files:"
            git diff --name-only
          fi

      - name: Commit and push fixes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Claude Auto-Fix Bot"
          git config user.email "claude-auto-fix[bot]@users.noreply.github.com"

          RETRY_NUM=${{ steps.retry-check.outputs.retry_count }}
          NEXT_NUM=$((RETRY_NUM + 1))

          git add -A
          git commit -m "ğŸ¤– Claude Auto-Fix (#$NEXT_NUM/3): è‡ªå‹•ä¿®å¾© lint/format éŒ¯èª¤

è‡ªå‹•ä¿®å¾©å…§å®¹:
- ESLint fixes
- Prettier formatting

æ­¤æ¬¡å˜—è©¦: $NEXT_NUM/3
Triggered by: CI failure on ${{ github.event.workflow_run.head_sha }}

ğŸ¤– Generated by Claude Auto-Fix workflow"

          git push

      - name: Comment on success
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const retry_count = ${{ steps.retry-check.outputs.retry_count }};
            const next_num = retry_count + 1;
            const issue_number = context.payload.workflow_run.pull_requests[0]?.number;

            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: `## ğŸ¤– Claude Auto-Fix å ±å‘Š (#${next_num}/3)

            âœ… å·²è‡ªå‹•ä¿®å¾©éƒ¨åˆ†å•é¡Œä¸¦é‡æ–°æ¨é€

            ### ä¿®å¾©å…§å®¹
            - ESLint è‡ªå‹•ä¿®å¾©
            - Prettier è‡ªå‹•æ ¼å¼åŒ–

            ### ç‹€æ…‹
            - å˜—è©¦æ¬¡æ•¸: ${next_num}/3
            - Branch: \`${{ github.event.workflow_run.head_branch }}\`
            - Commit: \`${context.sha}\`

            CI å°‡è‡ªå‹•é‡æ–°åŸ·è¡Œï¼Œè«‹ç¨å€™...`
              });
            }

      - name: Comment if no fixes possible
        if: steps.check-changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.workflow_run.pull_requests[0]?.number;

            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: `## âš ï¸ Claude Auto-Fix ç„¡æ³•è‡ªå‹•ä¿®å¾©

            CI å¤±æ•—äº†ï¼Œä½† Claude ç„¡æ³•æ‰¾åˆ°å¯è‡ªå‹•ä¿®å¾©çš„å•é¡Œã€‚

            å¯èƒ½çš„åŸå› :
            - æ¸¬è©¦é‚è¼¯éŒ¯èª¤ï¼ˆéœ€è¦æ‰‹å‹•ä¿®æ­£ï¼‰
            - é¡å‹éŒ¯èª¤ï¼ˆéœ€è¦é‡æ–°è¨­è¨ˆï¼‰
            - å…¶ä»–é lint/format å•é¡Œ

            è«‹æ‰‹å‹•æª¢æŸ¥ CI æ—¥èªŒ:
            ${{ github.event.workflow_run.html_url }}

            @Youngger9765`
              });
            }
